#!/usr/bin/env bash
set -e

REPO="https://github.com/defeat-beta/defeatbeta-api"
BRANCH="main"
INSTALL_DIR="$HOME/.defeatbeta"
TMP_TAR="/tmp/defeatbeta-mcp.tar.gz"

echo "ğŸš€ Installing defeatbeta MCP server (stdio mode)"
echo "ğŸ“ Install location: $INSTALL_DIR"
echo ""

# 1. Check python
if ! command -v python3 >/dev/null 2>&1; then
  echo "âŒ python3 is required but not found"
  exit 1
fi

# 2. Prepare directory
mkdir -p "$INSTALL_DIR"
cd "$INSTALL_DIR"

# 3. Download archive (robust way)
echo "ğŸ“¥ Downloading MCP source archive..."
curl -fL "$REPO/archive/refs/heads/$BRANCH.tar.gz" -o "$TMP_TAR"

# 4. Extract MCP files
echo "ğŸ“¦ Extracting MCP files..."
tar -xzf "$TMP_TAR"
rm -f "$TMP_TAR"

# Move only the mcp directory into place
rm -rf mcp
mv "defeatbeta-api-$BRANCH/mcp" .
rm -rf "defeatbeta-api-$BRANCH"

# 5. Create virtual environment
echo "ğŸ Creating virtual environment..."
python3 -m venv .venv
source .venv/bin/activate

pip install --upgrade pip

# 6. Install runtime dependencies (PyPI only)
echo "ğŸ“¦ Installing dependencies..."
pip install \
  mcp \
  defeatbeta-api \
  pandas

# 7. Permissions
chmod +x "$INSTALL_DIR"/mcp/run.sh

echo ""
echo "âœ… Installation completed successfully!"
echo ""
echo "ğŸ‘‰ MCP server entry:"
echo "   $INSTALL_DIR/mcp/run.sh"
echo ""
echo "ğŸ‘‰ Cherry Studio MCP config:"
echo "--------------------------------"
echo "{"
echo "  \"mcpServers\": {"
echo "   \"defeatbeta-finance\": {"
echo "      \"command\": \"/Users/kevin.zheng/.defeatbeta/mcp/run.sh\","
echo "      \"args\": []"
echo "   }"
echo "  }"
echo "}"
echo "--------------------------------"