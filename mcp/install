#!/usr/bin/env bash
set -e

REPO="https://github.com/defeatbeta/defeatbeta-api"
BRANCH="main"
INSTALL_DIR="$HOME/.defeatbeta/mcp"

echo "ğŸš€ Installing defeatbeta MCP server (stdio mode)"
echo "ğŸ“ Install location: $INSTALL_DIR"
echo ""

# 1. Check python
if ! command -v python3 >/dev/null 2>&1; then
  echo "âŒ python3 is required but not found"
  exit 1
fi

# 2. Prepare directory
mkdir -p "$INSTALL_DIR"
cd "$INSTALL_DIR"

# 3. Download MCP source only
echo "ğŸ“¥ Downloading MCP source..."
curl -sSL "$REPO/archive/refs/heads/$BRANCH.tar.gz" \
  | tar -xz --strip-components=2 "defeatbeta-api-$BRANCH/mcp"

# 4. Create virtual environment
echo "ğŸ Creating virtual environment..."
python3 -m venv .venv
source .venv/bin/activate

pip install --upgrade pip

# 5. Install runtime dependencies (PyPI only)
echo "ğŸ“¦ Installing dependencies..."
pip install \
  mcp \
  defeatbeta-api \
  pandas

# 6. Permissions
chmod +x run.sh

echo ""
echo "âœ… Installation completed successfully!"
echo ""
echo "ğŸ‘‰ MCP server entry:"
echo "   $INSTALL_DIR/run.sh"
echo ""
echo "ğŸ‘‰ Cherry Studio MCP config:"
echo "--------------------------------"
echo "{"
echo "  \"name\": \"defeatbeta-finance\","
echo "  \"command\": \"$INSTALL_DIR/run.sh\","
echo "  \"args\": []"
echo "}"
echo "--------------------------------"
